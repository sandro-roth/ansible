- name: system setup | firmware | check for available firmware updates
  tags: firmware
  command: fwupdmgr get-upgrades
  register: fwupd_check
  changed_when: false
  failed_when: false
  when:
    - ansible_os_family != "Darwin"
    - ansible_system == "Linux"

- name: system setup | firmware | install firmware upgrades if available
  tags: firmware
  command: fwupdmgr update -y
  when:
    - ansible_os_family != "Darwin"
    - ansible_system == "Linux"
    - fwupd_check is defined
    - fwupd_check.rc == 0
    - fwupd_check.stdout is defined
    - fwupd_check.stdout | length > 0
    - "'No detected devices with firmware updates' not in fwupd_check.stdout"
    - "'No upgrades for' not in fwupd_check.stdout"
    - "'Nothing to do' not in fwupd_check.stdout"

- name: system setup | firmware | upgrade all packages (apt only)
  tags: firmware
  apt:
    upgrade: dist
    update_cache: yes
  when: ansible_pkg_mgr == "apt"

- name: system setup | firmware | check if reboot is required (apt based)
  tags: firmware
  stat:
    path: /var/run/reboot-required
  register: reboot_required
  when:
    - ansible_os_family != "Darwin"
    - ansible_pkg_mgr == "apt"

- name: system setup | firmware | reboot if required
  tags: firmware
  reboot:
    msg: "Rebooting due to package or firmware updates"
    pre_reboot_delay: 10
  when:
    - ansible_os_family != "Darwin"
    - ansible_system == "Linux"
    - >
      (
        fwupd_check is defined
        and fwupd_check.rc == 0
        and 'No detected devices with firmware updates' not in fwupd_check.stdout
      )
      or
      (
        reboot_required is defined
        and reboot_required.stat.exists
      )
